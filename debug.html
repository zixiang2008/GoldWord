<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoldWord å¢å¼ºæœåŠ¡è°ƒè¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            /* é¡µé¢ä¸»ä½“å®½åº¦ï¼šå å±å¹•å·¦å³å®½åº¦çš„ 80% */
            width: 80vw;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f7;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1 style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <span>ğŸ”§ GoldWord å¢å¼ºæœåŠ¡è°ƒè¯•å·¥å…·</span>
        <div style="display:flex; align-items:center; gap:8px;">
            <button id="goToAuthCenterBtn" title="æ‰“å¼€ä¸ªäººä¸­å¿ƒ" style="font-size:14px; padding:8px 12px; border-radius:8px; background:#fff; color:#007aff; border:1px solid #cce3ff;">ä¸ªäººä¸­å¿ƒ</button>
            <a href="./index.html" style="font-size:14px; padding:8px 12px; border-radius:8px; background:#fff; color:#007aff; border:1px solid #cce3ff; text-decoration:none;">è¿”å›å­¦ä¹ </a>
            <button id="toggleRegressionPanelBtn" title="æ˜¾ç¤º/éšè—å›å½’æ£€æŸ¥é¢æ¿" style="font-size:14px; padding:8px 12px; border-radius:8px; background:#fff; color:#34c759; border:1px solid #cce3ff;">å›å½’æ£€æŸ¥</button>
        </div>
    </h1>
    <script>
      // é¡¶éƒ¨â€œä¸ªäººä¸­å¿ƒâ€æŒ‰é’®ï¼šè·³è½¬åˆ°é¦–é¡µå¹¶è‡ªåŠ¨æ‰“å¼€ä¸ªäººä¸­å¿ƒ
      (function(){
        var btn = document.getElementById('goToAuthCenterBtn');
        if (btn) {
          btn.addEventListener('click', function(){
            try {
              window.location.href = './index.html?open=auth';
            } catch(e) { console.warn('è·³è½¬ä¸ªäººä¸­å¿ƒå¤±è´¥:', e); }
          });
        }
      })();
    </script>

    <!-- å›å½’æ£€æŸ¥å®½åº¦å‚è€ƒçº¿ï¼ˆ10vw å·¦å³è¾¹è·å åŠ æ˜¾ç¤ºï¼‰ -->
    <div id="widthGuides" style="display:none; position:fixed; inset:0; pointer-events:none; z-index:9998;">
        <div id="leftGuide" style="position:absolute; left:0; top:0; bottom:0; width:10vw; background:rgba(0,122,255,0.08);"></div>
        <div id="rightGuide" style="position:absolute; right:0; top:0; bottom:0; width:10vw; background:rgba(0,122,255,0.08);"></div>
    </div>

    <!-- å›å½’æ£€æŸ¥é¢æ¿ï¼ˆæ˜¾ç¤ºè§†å£ã€é¡µé¢å®½åº¦ä¸æ¯”ä¾‹ã€æ–¹å‘ç­‰ï¼‰ -->
    <div id="regressionPanel" style="display:none; position:fixed; right:14px; bottom:14px; z-index:9999; background:#ffffff; border:1px solid #e6e6e6; box-shadow:0 6px 20px rgba(0,0,0,0.12); border-radius:12px; padding:12px; font-size:12px; color:#333;">
        <div style="font-weight:600; margin-bottom:6px;">å¿«é€Ÿå›å½’æ£€æŸ¥</div>
        <div>è§†å£ï¼š<span id="metricViewport">â€”</span></div>
        <div>é¡µé¢å®½åº¦ï¼š<span id="metricPageWidth">â€”</span></div>
        <div>æ¯”ä¾‹ï¼ˆé¡µé¢/è§†å£ï¼‰ï¼š<span id="metricRatio">â€”</span></div>
        <div>æ–¹å‘ï¼š<span id="metricOrientation">â€”</span></div>
        <div style="margin-top:8px; display:flex; gap:8px;">
            <button id="toggleGuidesBtn" style="padding:6px 10px; border:1px solid #d0e7ff; border-radius:8px; background:#f0f6ff; color:#007aff; cursor:pointer;">å‚è€ƒçº¿</button>
            <button id="closePanelBtn" style="padding:6px 10px; border:1px solid #eee; border-radius:8px; background:#fff; color:#444; cursor:pointer;">éšè—</button>
        </div>
    </div>
    
    <div class="card">
        <h2>ğŸ“Š æœåŠ¡çŠ¶æ€æ£€æŸ¥</h2>
        <div id="serviceStatus"></div>
        <button onclick="checkServiceStatus()">æ£€æŸ¥æœåŠ¡çŠ¶æ€</button>
    </div>

    <div class="card">
        <h2 style="display:flex; align-items:center; gap:10px;">
            âš™ï¸ GPT é…ç½®æµ‹è¯•
            <a href="https://api.apiyi.com/register/?aff_code=V1Kp" target="_blank" style="font-size:14px; font-weight:normal; color:#007aff; text-decoration:none; border:1px solid #cce3ff; padding:4px 8px; border-radius:6px;">å†…ç½®ä»£ç†GPTå¹³å°APIè·å–ï¼ˆä»˜è´¹ï¼‰</a>
        </h2>
        <div id="currentUserInfo" style="font-size: 13px; color: #555; margin-bottom: 8px;"></div>
        <div>
            <label>é¢„ç½®æ¨¡å‹ï¼ˆå¯é€‰ï¼‰:</label>
            <select id="testModelSelect"></select>
            <div id="testModelHelp" style="font-size: 12px; color: #666; margin: 6px 0;"></div>
        </div>
        <div>
            <label>API åŸºç¡€åœ°å€:</label>
            <input type="text" id="testBaseUrl" placeholder="https://api.openai.com/v1" />
            
            <label>æ¨¡å‹:</label>
            <input type="text" id="testModel" placeholder="gpt-4o-mini" />
            
            <label>API å¯†é’¥:</label>
            <input type="password" id="testApiKey" placeholder="sk-..." />
        </div>
        <button onclick="testGPTConfig()">æµ‹è¯• GPT è¿æ¥</button>
        <button onclick="saveGPTToDB()">ä¿å­˜åˆ°åº”ç”¨é…ç½®</button>
        <div id="gptTestResult"></div>
    </div>

    <div class="card">
        <!-- æ ‡é¢˜ä¸æ§ä»¶åˆå¹¶åˆ°åŒä¸€è¡Œæ˜¾ç¤º -->
        <div id="enhanceHeaderRow" style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:nowrap;">
            <h2 style="margin:0;">ğŸ§ª å¢å¼ºæµ‹è¯•</h2>
            <button id="btnRenderFromDB" title="åˆ·æ–°ç»“æœè¡¨" style="padding:6px 10px; border:1px solid #d0e7ff; border-radius:8px; background:#f0f6ff; color:#007aff; font-size:12px; cursor:pointer;">åˆ·æ–°</button>
            <!-- æ§ä»¶è¡Œï¼šå¤é€‰ã€è¯´æ˜ï¼ˆæ‚¬åœæŒ‰é’®ï¼‰ã€æµ‹è¯•æŒ‰é’®ã€è¾“å…¥æ¡† -->
            <div id="enhanceInlineRow" style="display:flex; align-items:center; gap:12px; flex-wrap:nowrap;"
                onmouseenter="try{var b=document.getElementById('forceEnhanceInfoBtn'); b.style.opacity='1'; b.style.pointerEvents='auto';}catch(_){}"
                onmouseleave="try{var b=document.getElementById('forceEnhanceInfoBtn'); b.style.opacity='0'; b.style.pointerEvents='none';}catch(_){}">
                <label style="display:flex; align-items:center; gap:6px; font-size:14px;">
                    <input type="checkbox" id="forceEnhanceAll" /> å¼ºåˆ¶å…¨éƒ¨å¢å¼º
                </label>
                <!-- æ‚¬åœæ˜¾ç¤ºçš„è¯´æ˜æŒ‰é’®ï¼ˆæ›¿æ¢åŸ span æ–‡æœ¬ï¼‰ -->
                <button id="forceEnhanceInfoBtn" role="button" aria-label="è¯´æ˜"
                        title="é€‰ä¸­åå°†å¯¹è¯åº“ä¸­æ‰€æœ‰å•è¯è¿›è¡Œæ™ºèƒ½å¢å¼ºï¼Œå¹¶æ˜¾ç¤ºè¿›åº¦ã€‚"
                        onclick="alert('é€‰ä¸­åå°†å¯¹è¯åº“ä¸­æ‰€æœ‰å•è¯è¿›è¡Œæ™ºèƒ½å¢å¼ºï¼Œå¹¶æ˜¾ç¤ºè¿›åº¦ã€‚')"
                        style="opacity:0; pointer-events:none; transition:opacity 150ms ease; padding:6px 10px; border:1px solid #d0e7ff; border-radius:8px; background:#f0f6ff; color:#007aff; font-size:12px; cursor:pointer;">
                    è¯´æ˜
                </button>
                <button onclick="testWordEnhancement()" style="background:#00c4b4; color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer;">
                    æµ‹è¯•å•è¯å¢å¼º
                </button>
                <div style="display:flex; align-items:center; gap:8px;">
                    <label for="testWord">æµ‹è¯•å•è¯:</label>
                    <input type="text" id="testWord" value="example" placeholder="è¾“å…¥è¦æµ‹è¯•çš„å•è¯" />
                </div>
            </div>
        </div>
        <div id="forceEnhanceProgress" style="display:none; margin-top:10px;">
            <div id="forceEnhanceProgressStatus" style="font-size:12px; color:#555; margin-bottom:6px;">å‡†å¤‡ä¸­...</div>
            <div style="width:100%; height:10px; background:#eee; border-radius:6px; overflow:hidden;">
                <div id="forceEnhanceProgressBar" style="height:10px; width:0%; background:#34c759;
                    transition: width 200ms ease;">
                </div>
            </div>
        </div>
        <div id="enhancementResult" style="margin-top:8px; font-size:14px;"></div>
        <!-- äºŒç»´è¡¨æ ¼ï¼šå±•ç¤ºæ¯ä¸ªå•è¯å„å­—æ®µçš„æœ€ç»ˆè¿”å›å€¼ï¼ˆExcelé£æ ¼ï¼‰ -->
        <div id="enhancementTableWrap" style="margin-top:12px;">
            <h3 style="margin:0 0 8px 0; font-weight:600;">å¢å¼ºç»“æœè¡¨ <span id="wordCountInfo" style="font-weight:400; color:#666; font-size:13px;"></span></h3>
            <!-- è¡¨æ ¼æ§åˆ¶åŒºï¼šå¯¼å‡ºä¸åˆ—æ˜¾ç¤ºå¼€å…³ -->
            <div id="enhancementTableControls" style="margin:8px 0 10px 0; display:flex; gap:10px; align-items:center; flex-wrap:nowrap; overflow-x:auto; white-space:nowrap;">
                <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" data-col-index="1" checked> å•è¯</label>
                <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" data-col-index="2" checked> éŸ³æ ‡</label>
                <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" data-col-index="3" checked> è¯æ€§</label>
                <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" data-col-index="4" checked> å®šä¹‰</label>
                <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" data-col-index="5" checked> ä¸­æ–‡</label>
                <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" data-col-index="6" checked> å›ºå®šæ­é…</label>
                <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" data-col-index="7" checked> åŒè¯­ä¾‹å¥</label>
                <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" data-col-index="8" checked> è®°å¿†è¦ç‚¹</label>
                <label style="display:flex; gap:6px; align-items:center;"><input type="checkbox" data-col-index="9" checked> è”æƒ³</label>
            </div>
            <div style="overflow:auto; border:1px solid #eee; border-radius:6px; resize: horizontal; width:100%; min-width:480px;">
                <table id="enhancementTable" style="width:100%; border-collapse:collapse; font-size:14px; table-layout: fixed;">
                    <colgroup>
                        <col data-col-index="1" style="width:auto;" />
                        <col data-col-index="2" style="width:auto;" />
                        <col data-col-index="3" style="width:auto;" />
                        <col data-col-index="4" style="width:auto;" />
                        <col data-col-index="5" style="width:auto;" />
                        <col data-col-index="6" style="width:auto;" />
                        <col data-col-index="7" style="width:auto;" />
                        <col data-col-index="8" style="width:auto;" />
                        <col data-col-index="9" style="width:auto;" />
                    </colgroup>
                    <thead style="background:#f7f7f7; position:sticky; top:0;">
                        <tr>
                            <th style="border:1px solid #eee; padding:6px;">å•è¯</th>
                            <th style="border:1px solid #eee; padding:6px;">éŸ³æ ‡</th>
                            <th style="border:1px solid #eee; padding:6px;">è¯æ€§</th>
                            <th style="border:1px solid #eee; padding:6px;">ä¸»è¦ç”¨æ³•/å®šä¹‰</th>
                            <th style="border:1px solid #eee; padding:6px;">ä¸­æ–‡è§£é‡Š</th>
                            <th style="border:1px solid #eee; padding:6px;">å›ºå®šæ­é…</th>
                            <th style="border:1px solid #eee; padding:6px;">ä¾‹å¥(ä¸­/è‹±)</th>
                            <th style="border:1px solid #eee; padding:6px;">è®°å¿†è¦ç‚¹</th>
                            <th style="border:1px solid #eee; padding:6px;">è”æƒ³</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“ è°ƒè¯•æ—¥å¿—</h2>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
            <button onclick="copyLogToClipboard()" title="å¤åˆ¶åˆ°è°ƒè¯•åé¦ˆ">å¤åˆ¶åˆ°è°ƒè¯•åé¦ˆ</button>
        </div>
        <div id="debugLog" class="log" style="font-size:14px;">æ—¥å¿—è¾“å‡ºå°†åœ¨æ­¤æ˜¾ç¤º...</div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="storage.js"></script>
    <!-- SA (StorageAdapter å›é€€æœºåˆ¶)ï¼šä¾› db.js ä½¿ç”¨ -->
    <script>
        // åœ¨è°ƒè¯•é¡µä¸­æä¾› SA å…¨å±€å˜é‡ï¼Œé¿å… "SA is not defined"
        window.SA = (typeof StorageAdapter !== 'undefined') ? StorageAdapter : {
            getItem: function(key){ try { return localStorage.getItem(key); } catch(_) { return null; } },
            setItem: function(key, value){ try { localStorage.setItem(key, String(value)); } catch(_) {} },
            removeItem: function(key){ try { localStorage.removeItem(key); } catch(_) {} },
            getJSON: function(key){ var raw = this.getItem(key); if (!raw) return null; try { return JSON.parse(raw); } catch(_) { return null; } },
            setJSON: function(key, value){ try { this.setItem(key, JSON.stringify(value)); } catch(_) {} }
        };

        /**
         * åˆå§‹åŒ–å›å½’æ£€æŸ¥é¢æ¿ä¸å‚è€ƒçº¿ã€‚
         * åŠŸèƒ½ï¼šæ˜¾ç¤ºè§†å£å°ºå¯¸ã€é¡µé¢å®½åº¦ã€å®½åº¦å æ¯”ï¼ˆåº”çº¦ç­‰äº 80%ï¼‰ã€å½“å‰æ–¹å‘ï¼›æ”¯æŒå‚è€ƒçº¿å¼€å…³ä¸äº‹ä»¶ç»‘å®šã€‚
         * å‚æ•°ï¼šæ— 
         * è¿”å›ï¼šæ— 
         */
        function initRegressionPanel(){
            try {
                var toggleBtn = document.getElementById('toggleRegressionPanelBtn');
                var panel = document.getElementById('regressionPanel');
                var guides = document.getElementById('widthGuides');
                var toggleGuidesBtn = document.getElementById('toggleGuidesBtn');
                var closePanelBtn = document.getElementById('closePanelBtn');

                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function(){
                        panel.style.display = (panel.style.display === 'none' || !panel.style.display) ? 'block' : 'none';
                        updateRegressionMetrics();
                    });
                }
                if (toggleGuidesBtn) {
                    toggleGuidesBtn.addEventListener('click', function(){
                        var show = (guides.style.display === 'none' || !guides.style.display);
                        guides.style.display = show ? 'block' : 'none';
                        updateRegressionMetrics();
                    });
                }
                if (closePanelBtn) {
                    closePanelBtn.addEventListener('click', function(){
                        panel.style.display = 'none';
                    });
                }

                // è§†å£å˜åŒ–ä¸æ–¹å‘åˆ‡æ¢æ—¶æ›´æ–°
                window.addEventListener('resize', function(){
                    updateRegressionMetrics();
                });
                window.addEventListener('orientationchange', function(){
                    setTimeout(updateRegressionMetrics, 50);
                });
                document.addEventListener('DOMContentLoaded', function(){
                    updateRegressionMetrics();
                });
            } catch(e) { console.warn('åˆå§‹åŒ–å›å½’æ£€æŸ¥é¢æ¿å¤±è´¥:', e); }
        }

        /**
         * æ›´æ–°å›å½’æ£€æŸ¥åº¦é‡ä¿¡æ¯ã€‚
         * åŠŸèƒ½ï¼šè®¡ç®—è§†å£å°ºå¯¸ã€é¡µé¢å®½åº¦ï¼ˆbodyï¼‰ã€é¡µé¢/è§†å£æ¯”ä¾‹ä¸æ–¹å‘ï¼Œå¹¶æ¸²æŸ“åˆ°é¢æ¿ã€‚
         * å‚æ•°ï¼šæ— 
         * è¿”å›ï¼šæ— 
         */
        function updateRegressionMetrics(){
            try {
                var vpW = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
                var vpH = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
                var pageRect = document.body.getBoundingClientRect();
                var pageW = Math.round(pageRect.width);
                var ratio = vpW ? Math.round((pageW / vpW) * 1000) / 10 : 0; // ç™¾åˆ†æ¯”ä¸€ä½å°æ•°
                var orientation = (screen.orientation && screen.orientation.type) ? screen.orientation.type : (vpW >= vpH ? 'landscape' : 'portrait');

                var elVp = document.getElementById('metricViewport');
                var elPw = document.getElementById('metricPageWidth');
                var elR = document.getElementById('metricRatio');
                var elO = document.getElementById('metricOrientation');

                if (elVp) elVp.textContent = vpW + ' Ã— ' + vpH;
                if (elPw) elPw.textContent = pageW + 'px';
                if (elR) elR.textContent = ratio + '%';
                if (elO) elO.textContent = orientation;
            } catch(e) { /* å¿½ç•¥åº¦é‡æ›´æ–°é”™è¯¯ */ }
        }

        // åˆå§‹åŒ–å›å½’æ£€æŸ¥å·¥å…·
        try { initRegressionPanel(); } catch(_) {}
    </script>
    <script src="db.js"></script>
    <script src="word-schema.js"></script>
    <script src="word-enhancement-service.js"></script>
    <script src="built-in-models.js"></script>

    <script>
        // é‡å†™console.logä»¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        function addToLog(type, ...args) {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            if (!logDiv) return; // è‹¥æ—¥å¿—å®¹å™¨è¢«ç§»é™¤ï¼Œåˆ™ç›´æ¥è·³è¿‡
            logDiv.textContent += `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog('log', ...args);
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToLog('warn', ...args);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog('error', ...args);
        };

        function clearLog() {
            const el = document.getElementById('debugLog');
            if (el) el.textContent = '';
        }

        async function copyLogToClipboard() {
            try {
                const el = document.getElementById('debugLog');
                const text = (el && el.textContent) ? el.textContent : '';
                if (!text) {
                    console.warn('è°ƒè¯•æ—¥å¿—ä¸ºç©ºï¼Œæ— éœ€å¤åˆ¶');
                }
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    // Fallbackï¼šåˆ›å»ºä¸´æ—¶æ–‡æœ¬åŸŸé€‰æ‹©å¤åˆ¶
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                }
                console.log('âœ… è°ƒè¯•æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (e) {
                console.error('å¤åˆ¶è°ƒè¯•æ—¥å¿—å¤±è´¥:', e);
            }
        }

        function checkServiceStatus() {
            const statusDiv = document.getElementById('serviceStatus');
            
            try {
                if (typeof wordEnhancementService === 'undefined') {
                    statusDiv.innerHTML = '<div class="status error">âŒ å¢å¼ºæœåŠ¡æœªåŠ è½½</div>';
                    return;
                }
                
                const status = wordEnhancementService.getServiceStatus();
                console.log('æœåŠ¡çŠ¶æ€:', status);
                
                let html = '';
                
                // æœåŠ¡åŸºæœ¬çŠ¶æ€
                html += `<div class="status ${status.isProcessing ? 'warning' : 'success'}">
                    ${status.isProcessing ? 'â³' : 'âœ…'} æœåŠ¡çŠ¶æ€: ${status.isProcessing ? 'å¤„ç†ä¸­' : 'å°±ç»ª'}
                </div>`;
                
                // æœ¬åœ°è¯å…¸çŠ¶æ€
                html += `<div class="status ${status.hasLocalDictionary ? 'success' : 'warning'}">
                    ${status.hasLocalDictionary ? 'ğŸ“š' : 'ğŸ“–'} æœ¬åœ°è¯å…¸: ${status.hasLocalDictionary ? `å·²åŠ è½½ (${status.localDictionarySize} è¯æ¡)` : 'æœªåŠ è½½'}
                </div>`;
                
                // GPTé…ç½®çŠ¶æ€
                html += `<div class="status ${status.gptConfigured ? 'success' : 'warning'}">
                    ${status.gptConfigured ? 'ğŸ¤–' : 'âš ï¸'} GPTé…ç½®: ${status.gptConfigured ? 'å·²é…ç½®' : 'æœªé…ç½®'}
                </div>`;
                
                if (status.gptConfig) {
                    html += `<div style="margin-left: 20px; font-size: 14px;">
                        â€¢ APIå¯†é’¥: ${status.gptConfig.hasApiKey ? 'âœ… å·²è®¾ç½®' : 'âŒ æœªè®¾ç½®'}<br>
                        â€¢ åŸºç¡€URL: ${status.gptConfig.hasBaseUrl ? 'âœ… ' + status.gptConfig.baseUrl : 'âŒ æœªè®¾ç½®'}<br>
                        â€¢ æ¨¡å‹: ${status.gptConfig.hasModel ? 'âœ… ' + status.gptConfig.model : 'âŒ æœªè®¾ç½®'}
                    </div>`;
                }
                
                statusDiv.innerHTML = html;
                
            } catch (error) {
                console.error('æ£€æŸ¥æœåŠ¡çŠ¶æ€å¤±è´¥:', error);
                statusDiv.innerHTML = '<div class="status error">âŒ æ£€æŸ¥å¤±è´¥: ' + error.message + '</div>';
            }
        }

        async function testGPTConfig() {
            const resultDiv = document.getElementById('gptTestResult');
            const baseUrl = document.getElementById('testBaseUrl').value.trim();
            const model = document.getElementById('testModel').value.trim();
            const apiKey = document.getElementById('testApiKey').value.trim();
            
            if (!baseUrl || !model || !apiKey) {
                resultDiv.innerHTML = '<div class="status error">âŒ è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="status warning">â³ æµ‹è¯•ä¸­...</div>';
            
            try {
                console.log('æµ‹è¯•GPTé…ç½®...');
                
                const testConfig = { baseUrl, model, apiKey };
                
                // ä½¿ç”¨Appçš„æµ‹è¯•æ–¹æ³•ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                if (typeof App !== 'undefined' && App.testGPTSettings) {
                    const result = await App.testGPTSettings(testConfig);
                    if (result.ok) {
                        resultDiv.innerHTML = '<div class="status success">âœ… GPTè¿æ¥æµ‹è¯•æˆåŠŸ</div>';
                    } else {
                        resultDiv.innerHTML = `<div class="status error">âŒ GPTè¿æ¥æµ‹è¯•å¤±è´¥: ${result.error}</div>`;
                    }
                } else {
                    // ç›´æ¥æµ‹è¯•API
                    // è§„èŒƒåŒ–åŸºç¡€åœ°å€ï¼Œè¡¥é½ /v1
                    let base = (baseUrl || '').trim().replace(/\/$/, '');
                    if (!/\/v1\/?$/.test(base)) { base = base + '/v1'; }
                    const apiUrl = base + '/chat/completions';
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: [{ role: 'user', content: 'Hello' }],
                            max_tokens: 10
                        })
                    });
                    
                    if (response.ok) {
                        resultDiv.innerHTML = '<div class="status success">âœ… GPTè¿æ¥æµ‹è¯•æˆåŠŸ</div>';
                    } else {
                        const errorText = await response.text();
                        resultDiv.innerHTML = `<div class="status error">âŒ GPTè¿æ¥æµ‹è¯•å¤±è´¥: ${response.status} - ${errorText}</div>`;
                    }
                }
                
            } catch (error) {
                console.error('GPTæµ‹è¯•å¤±è´¥:', error);
                resultDiv.innerHTML = `<div class="status error">âŒ æµ‹è¯•å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function testWordEnhancement() {
            const resultDiv = document.getElementById('enhancementResult');
            const word = document.getElementById('testWord').value.trim();
            const forceAll = !!document.getElementById('forceEnhanceAll')?.checked;

            // åˆ†æ”¯ï¼šå¼ºåˆ¶å…¨éƒ¨å¢å¼º
            if (forceAll) {
                await runForcedEnhancementAll();
                return;
            }
            
            if (!word) {
                resultDiv.innerHTML = '<div class="status error">âŒ è¯·è¾“å…¥è¦æµ‹è¯•çš„å•è¯</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="status warning">â³ å¢å¼ºä¸­...</div>';
            
            try {
                console.log(`æµ‹è¯•å•è¯å¢å¼º: ${word}`);
                
                if (typeof wordEnhancementService === 'undefined') {
                    resultDiv.innerHTML = '<div class="status error">âŒ å¢å¼ºæœåŠ¡ä¸å¯ç”¨</div>';
                    return;
                }
                
                const testWordObj = { word: word };
                const enhanced = await wordEnhancementService.enhanceWord(testWordObj);
                
                console.log('å¢å¼ºç»“æœ:', enhanced);
                
                let html = '<div class="status success">âœ… å¢å¼ºå®Œæˆ</div>';
                
                resultDiv.innerHTML = html;

                // æ¸²æŸ“å•æ¡è®°å½•åˆ°äºŒç»´è¡¨æ ¼
                try { renderEnhancementTable([enhanced]); } catch(_){}
                
            } catch (error) {
                console.error('å•è¯å¢å¼ºæµ‹è¯•å¤±è´¥:', error);
                resultDiv.innerHTML = `<div class="status error">âŒ å¢å¼ºå¤±è´¥: ${error.message}</div>`;
            }
        }

        async function runForcedEnhancementAll() {
            try {
                const barWrap = document.getElementById('forceEnhanceProgress');
                const bar = document.getElementById('forceEnhanceProgressBar');
                const status = document.getElementById('forceEnhanceProgressStatus');
                if (barWrap) barWrap.style.display = 'block';
                if (bar) bar.style.width = '0%';
                if (status) status.textContent = 'å‡†å¤‡ä¸­...';

                if (typeof wordEnhancementService === 'undefined') {
                    console.error('å¢å¼ºæœåŠ¡ä¸å¯ç”¨ï¼Œæ— æ³•æ‰§è¡Œå¼ºåˆ¶å…¨éƒ¨å¢å¼º');
                    if (status) status.textContent = 'âŒ å¢å¼ºæœåŠ¡ä¸å¯ç”¨';
                    return;
                }

                let allWords = [];
                try { allWords = (typeof DB !== 'undefined' && DB.getAllWords) ? (DB.getAllWords() || []) : []; } catch(_){ allWords = []; }
                if (!Array.isArray(allWords) || allWords.length === 0) {
                    console.warn('è¯åº“ä¸ºç©ºæˆ–ä¸å¯ç”¨ï¼Œå¼ºåˆ¶å¢å¼ºè·³è¿‡');
                    if (status) status.textContent = 'âš ï¸ è¯åº“ä¸ºç©ºæˆ–ä¸å¯ç”¨';
                    return;
                }

                console.log(`å¼ºåˆ¶å…¨éƒ¨å¢å¼ºå¯åŠ¨ï¼Œå…± ${allWords.length} ä¸ªè¯`);

                // è®¾ç½®è°ƒè¯•é¡µä¸“ç”¨è¿›åº¦å›è°ƒ
                try {
                    wordEnhancementService.setProgressCallback(function(current, total, enhanced){
                        const percent = total > 0 ? Math.round((current / total) * 100) : 0;
                        if (bar) bar.style.width = percent + '%';
                        if (status) status.textContent = `è¿›åº¦ï¼š${current}/${total}ï¼ˆå·²å¢å¼ºï¼š${enhanced}ï¼‰`;
                        console.log(`è¿›åº¦æ›´æ–°ï¼š${current}/${total}ï¼Œå·²å¢å¼ºï¼š${enhanced}`);
                    });
                } catch(_){ }

                // æ‰§è¡Œæ‰¹é‡å¢å¼º
                const enhancedWords = await wordEnhancementService.batchEnhanceWords(allWords, { force: true });
                if (status) status.textContent = `âœ… å®Œæˆï¼šå¤„ç† ${enhancedWords.length}/${allWords.length}`;
                if (bar) bar.style.width = '100%';
                console.log('å¼ºåˆ¶å…¨éƒ¨å¢å¼ºå®Œæˆï¼Œç»“æœç¤ºä¾‹ï¼š', (enhancedWords[0] || {}));

                // æ¸²æŸ“æ‰¹é‡ç»“æœåˆ°äºŒç»´è¡¨æ ¼
                try { renderEnhancementTable(enhancedWords); } catch(_){}
            } catch (e) {
                console.error('å¼ºåˆ¶å…¨éƒ¨å¢å¼ºå¤±è´¥:', e);
            }
        }

        // æ¸²æŸ“å¢å¼ºç»“æœä¸ºäºŒç»´è¡¨æ ¼ï¼ˆExcelé£æ ¼ï¼‰
        function renderEnhancementTable(words) {
            try {
                const table = document.getElementById('enhancementTable');
                const tbody = table ? table.querySelector('tbody') : null;
                if (!tbody) return;
                // æ¸…ç©ºæ—§è¡Œ
                tbody.innerHTML = '';
                const toStr = (v) => Array.isArray(v) ? v.join('\n') : String(v || '').trim();
                const escapeHtml = (s) => String(s || '').replace(/[&<>"]/g, function(ch){
                    switch(ch){case '&': return '&amp;'; case '<': return '&lt;'; case '>': return '&gt;'; case '"': return '&quot;'; default: return ch; }
                });

                // æ•°æ®æºæ¥è‡ªæœ€ç»ˆåˆå¹¶ç»“æ„ï¼šé¡¶å±‚ + aiEnhanced
                (words || []).forEach(function(w){
                    const phon = w.phonetic || '';
                    const pos = w.partOfSpeech || '';
                    const def = w.definition || (w.aiEnhanced && w.aiEnhanced.definition) || '';
                    const zh = w.chinese || (w.aiEnhanced && w.aiEnhanced.chineseMeaning) || '';
                    const collRaw = (w.collocation || '') || ((w.aiEnhanced && w.aiEnhanced.collocations) || []);
                    // è§„èŒƒåŒ–å¹¶æ„å»ºä¸­è‹±æ˜¾ç¤ºï¼ŒåŒæ—¶ä¸ºç¼ºå¤±ä¸­æ–‡å‡†å¤‡å¼‚æ­¥å›å¡«
                    const collItems = (Array.isArray(collRaw) ? collRaw : String(collRaw || '').split(/\n|ï¼›|;|ï¼Œ/))
                        .map(function(item){
                            if (typeof item === 'string') {
                                const s = String(item || '').trim();
                                if (!s) return null;
                                const parts = s.includes('ï¼š') ? s.split('ï¼š')
                                    : (s.includes(':') ? s.split(':')
                                    : s.split('+'));
                                const en = (parts[0] || '').trim();
                                const zh = (parts[1] || '').trim();
                                return { en, zh };
                            }
                            if (item && typeof item === 'object') {
                                const en = String(item.phrase || item.en || '').trim();
                                const zh = String(item.meaning || item.zh || '').trim();
                                return { en, zh };
                            }
                            return null;
                        })
                        .filter(Boolean);
                    // å»é‡åŒè‹±æ–‡
                    (function(){
                        const seen = new Set();
                        let i = 0;
                        while (i < collItems.length) {
                            const key = (collItems[i].en || '').trim().toLowerCase();
                            if (key && seen.has(key)) { collItems.splice(i,1); continue; }
                            if (key) seen.add(key);
                            i += 1;
                        }
                    })();
                    const collDisplay = collItems.map(function(c){ return c.en ? (c.zh ? (c.en + 'ï¼š' + c.zh) : c.en) : ''; }).filter(Boolean).join('\n');

                    // å°†è§„èŒƒåŒ–åçš„å›ºå®šæ­é…ä¸ä¾‹å¥è½åº“ï¼ˆæ¸²æŸ“æ—¶å†™å…¥ï¼‰
                    try {
                        if (typeof DB !== 'undefined' && DB.getAllWords) {
                            const allWordsDB = DB.getAllWords() || [];
                            const existing = allWordsDB.find(function(x){ return x && x.word === w.word; });
                            const normColls = collItems.map(function(c){ return { en: c.en || '', zh: c.zh || '' }; });
                            const normExamples = exItems.slice(0, 3).map(function(e){ return { en: e.en || '', zh: e.zh || '' }; });
                            if (existing) {
                                existing.collocations = normColls;
                                existing.examples = normExamples;
                                DB.saveFileData(allWordsDB);
                            } else if (DB.saveWordData) {
                                DB.saveWordData({ word: w.word, collocations: normColls, examples: normExamples });
                            }
                        }
                    } catch(_){ }

                    // ä¾‹å¥ï¼šå»é‡è‹±æ–‡å¹¶ä¿ç•™ä¸­è‹±å¯¹
                    const exRaw = Array.isArray(w.examples) ? w.examples : [];
                    const exItems = exRaw.map(function(e){ return { en: String(e.en || '').trim(), zh: String(e.zh || '').trim() }; });
                    (function(){
                        const seen = new Set();
                        let i = 0;
                        while (i < exItems.length) {
                            const key = (exItems[i].en || '').toLowerCase();
                            if (key && seen.has(key)) { exItems.splice(i,1); continue; }
                            if (key) seen.add(key);
                            i += 1;
                        }
                    })();
                    const ex = exItems.map(function(e){ return `${e.zh || ''} | ${e.en || ''}`; }).join('\n');
                    const memo = (w.mnemonic || '') || ((w.aiEnhanced && w.aiEnhanced.memoryTip) || '');
                    const assoc = (w.association || '') || ((w.aiEnhanced && w.aiEnhanced.association) || '');

                    const tr = document.createElement('tr');
                    const values = [w.word||'', phon, pos, def, zh, collDisplay, ex, memo, assoc];
                    const cells = values.map(function(val){
                        const td = document.createElement('td');
                        td.style.border = '1px solid #eee';
                        td.style.padding = '6px';
                        td.style.verticalAlign = 'top';
                        td.style.whiteSpace = 'pre-wrap';
                        td.innerHTML = escapeHtml(toStr(val));
                        return td;
                    });
                    cells.forEach(function(td){ tr.appendChild(td); });
                    tbody.appendChild(tr);

                    // å¼‚æ­¥è¡¥é½å›ºå®šæ­é…çš„ä¸­æ–‡å«ä¹‰ä¸ä¾‹å¥ç¼ºå¤±çš„ä¸­æ–‡
                    try {
                        const collTd = cells[5];
                        const exampleTd = cells[6];
                        if (window.wordEnhancementService && typeof window.wordEnhancementService.translateTextToChinese === 'function') {
                            // å›ºå®šæ­é…ä¸­æ–‡
                            collItems.forEach(function(item, idx){
                                if (item.en && !item.zh) {
                                    window.wordEnhancementService.translateTextToChinese(item.en).then(function(zhTxt){
                                        const t = String(zhTxt || '').trim();
                                        if (!t) return;
                                        item.zh = t;
                                        const lines = collItems.map(function(c){ return c.en ? (c.zh ? (c.en + 'ï¼š' + c.zh) : c.en) : ''; }).filter(Boolean);
                                        if (collTd) collTd.textContent = lines.join('\n');
                                        // è½åº“å›å¡«ä¸­æ–‡
                                        try {
                                            if (typeof DB !== 'undefined' && DB.getAllWords) {
                                                const allWordsDB = DB.getAllWords() || [];
                                                const existing = allWordsDB.find(function(x){ return x && x.word === w.word; });
                                                const normColls = collItems.map(function(c){ return { en: c.en || '', zh: c.zh || '' }; });
                                                if (existing) {
                                                    existing.collocations = normColls;
                                                    DB.saveFileData(allWordsDB);
                                                } else if (DB.saveWordData) {
                                                    DB.saveWordData({ word: w.word, collocations: normColls });
                                                }
                                            }
                                        } catch(_){ }
                                    }).catch(function(){});
                                }
                            });
                            // ä¾‹å¥ä¸­æ–‡
                            exItems.forEach(function(ex){
                                if (ex.en && !ex.zh) {
                                    window.wordEnhancementService.translateTextToChinese(ex.en).then(function(zhTxt){
                                        const t = String(zhTxt || '').trim();
                                        if (!t) return;
                                        ex.zh = t;
                                        const lines = exItems.map(function(e){ return `${e.zh || ''} | ${e.en || ''}`; });
                                        if (exampleTd) exampleTd.textContent = lines.join('\n');
                                        // è½åº“å›å¡«ä¸­æ–‡
                                        try {
                                            if (typeof DB !== 'undefined' && DB.getAllWords) {
                                                const allWordsDB = DB.getAllWords() || [];
                                                const existing = allWordsDB.find(function(x){ return x && x.word === w.word; });
                                                const normExamples = exItems.slice(0, 3).map(function(e){ return { en: e.en || '', zh: e.zh || '' }; });
                                                if (existing) {
                                                    existing.examples = normExamples;
                                                    DB.saveFileData(allWordsDB);
                                                } else if (DB.saveWordData) {
                                                    DB.saveWordData({ word: w.word, examples: normExamples });
                                                }
                                            }
                                        } catch(_){ }
                                    }).catch(function(){});
                                }
                            });
                        }
                    } catch(_){ }
                });
            } catch (e) {
                console.error('æ¸²æŸ“å¢å¼ºç»“æœè¡¨å¤±è´¥:', e);
            }
        }

        // ä»æ•°æ®åº“åŠ è½½å¹¶æ¸²æŸ“è¡¨æ ¼
        function renderEnhancementTableFromDB() {
            try {
                let words = [];
                try { words = (typeof DB !== 'undefined' && DB.getAllWords) ? (DB.getAllWords() || []) : []; } catch (_) { words = []; }
                if (!Array.isArray(words) || words.length === 0) {
                    console.warn('æ•°æ®åº“ä¸­æš‚æ— è¯æ¡');
                }
                renderEnhancementTable(words);
            } catch (e) {
                console.error('ä»æ•°æ®åº“åŠ è½½è¡¨æ ¼å¤±è´¥:', e);
            }
        }

        // å¯¼å‡ºå½“å‰è¡¨æ ¼ä¸º CSV æ–‡ä»¶
        function exportEnhancementTableCSV() {
            try {
                const table = document.getElementById('enhancementTable');
                if (!table) return;
                const thead = table.querySelector('thead');
                const tbody = table.querySelector('tbody');
                const headers = Array.from(thead.querySelectorAll('th'))
                    .filter((th) => th.style.display !== 'none')
                    .map((th) => th.textContent.trim());
                const rows = Array.from(tbody.querySelectorAll('tr')).map(function(tr){
                    return Array.from(tr.children)
                        .filter((td) => td.style.display !== 'none')
                        .map((td) => td.textContent || '');
                });

                const csvEscape = function(val){
                    const s = String(val || '').replace(/\r?\n/g, '\n');
                    const needsQuotes = /[",\n]/.test(s);
                    const q = s.replace(/"/g, '""');
                    return needsQuotes ? `"${q}"` : q;
                };

                const lines = [];
                lines.push(headers.map(csvEscape).join(','));
                rows.forEach(function(row){ lines.push(row.map(csvEscape).join(',')); });
                const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'enhancement-results.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (e) {
                console.error('å¯¼å‡º CSV å¤±è´¥:', e);
            }
        }

        // åˆ—æ˜¾ç¤ºå¼€å…³ï¼šéšè—/æ˜¾ç¤ºæŒ‡å®šåˆ—
        function setupColumnVisibilityControls() {
            try {
                const controls = document.getElementById('enhancementTableControls');
                if (!controls) return;
                const table = document.getElementById('enhancementTable');
                if (!table) return;

                // æ´¾å‘åˆ‡æ¢äº‹ä»¶
                const checkboxes = controls.querySelectorAll('input[type="checkbox"][data-col-index]');
                checkboxes.forEach(function(cb){
                    cb.addEventListener('change', function(){
                        const index = parseInt(cb.getAttribute('data-col-index'), 10);
                        const visible = !!cb.checked;
                        toggleColumnVisibility(index, visible);
                    });
                });

                // åˆå§‹åŒæ­¥ä¸€æ¬¡ï¼Œä»¥é˜²åˆ·æ–°åä¿ç•™çŠ¶æ€
                checkboxes.forEach(function(cb){
                    const index = parseInt(cb.getAttribute('data-col-index'), 10);
                    toggleColumnVisibility(index, !!cb.checked);
                });

                // æŒ‰åˆ—åˆ‡æ¢æ˜¾ç¤º
                function toggleColumnVisibility(index, visible) {
                    try {
                        const ths = table.querySelectorAll(`thead th:nth-child(${index})`);
                        const tds = table.querySelectorAll(`tbody td:nth-child(${index})`);
                        const col = table.querySelector(`colgroup col:nth-child(${index})`);
                        ths.forEach(function(el){ el.style.display = visible ? '' : 'none'; });
                        tds.forEach(function(el){ el.style.display = visible ? '' : 'none'; });
                        if (col) { col.style.display = visible ? '' : 'none'; }
                    } catch (e) {
                        console.error('åˆ‡æ¢åˆ—æ˜¾ç¤ºå¤±è´¥:', e);
                    }
                }

                // ç»‘å®šæŒ‰é’®
                document.getElementById('btnExportCSV')?.addEventListener('click', exportEnhancementTableCSV);
                document.getElementById('btnRenderFromDB')?.addEventListener('click', renderEnhancementTableFromDB);
            } catch (e) {
                console.error('åˆå§‹åŒ–åˆ—æ˜¾ç¤ºæ§åˆ¶å¤±è´¥:', e);
            }
        }

        // åˆ—å®½æ‹–æ‹½è°ƒæ•´
        function setupColumnResizers() {
            try {
                const table = document.getElementById('enhancementTable');
                if (!table) return;
                const colgroup = table.querySelector('colgroup');
                const headerCells = table.querySelectorAll('thead th');
                if (!colgroup || !headerCells.length) return;

                // æ³¨å…¥ç®€æ˜“æ ·å¼
                if (!document.getElementById('colResizerStyles')) {
                    const style = document.createElement('style');
                    style.id = 'colResizerStyles';
                    style.textContent = `.col-resizer{position:absolute;right:0;top:0;width:6px;height:100%;cursor:col-resize;user-select:none}`;
                    document.head.appendChild(style);
                }

                table.style.tableLayout = 'fixed';
                headerCells.forEach(function(th, idx){
                    th.style.position = 'relative';
                    const handle = document.createElement('span');
                    handle.className = 'col-resizer';
                    th.appendChild(handle);

                    let startX = 0; let startWidth = 0; let active = false;
                    const col = colgroup.children[idx];
                    const onMouseMove = function(e){
                        if (!active) return;
                        const delta = e.pageX - startX;
                        const newW = Math.max(60, startWidth + delta);
                        if (col) { col.style.width = newW + 'px'; }
                        // åŒæ­¥è¡¨å¤´å•å…ƒæ ¼å®½åº¦ï¼Œé¿å…æ–‡å­—æ¢è¡Œå¼‚å¸¸
                        th.style.width = newW + 'px';
                    };
                    const onMouseUp = function(){
                        if (!active) return;
                        active = false;
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };
                    handle.addEventListener('mousedown', function(e){
                        active = true;
                        startX = e.pageX;
                        const useEl = col && col.offsetWidth ? col : th;
                        startWidth = useEl.offsetWidth || th.offsetWidth;
                        document.addEventListener('mousemove', onMouseMove);
                        document.addEventListener('mouseup', onMouseUp);
                        e.preventDefault();
                    });
                });
            } catch (e) {
                console.error('åˆå§‹åŒ–åˆ—å®½æ‹–æ‹½å¤±è´¥:', e);
            }
        }

        // åˆå§‹åŒ–æ§åˆ¶åŒºå’Œåˆ—å®½æ‹–æ‹½ï¼ˆé¡µé¢åŠ è½½åè°ƒç”¨ä¸€æ¬¡ï¼‰
        try { setupColumnVisibilityControls(); } catch(_) {}
        try { setupColumnResizers(); } catch(_) {}

        async function saveGPTToDB() {
            const resultDiv = document.getElementById('gptTestResult');
            const baseUrl = document.getElementById('testBaseUrl').value.trim();
            const model = document.getElementById('testModel').value.trim();
            const apiKey = document.getElementById('testApiKey').value.trim();

            if (!baseUrl || !model || !apiKey) {
                resultDiv.innerHTML = '<div class="status error">âŒ è¯·å¡«å†™å®Œæ•´çš„é…ç½®ä¿¡æ¯åå†ä¿å­˜</div>';
                return;
            }

            try {
                const cfg = { baseUrl, model, apiKey };
                if (typeof DB !== 'undefined' && DB.saveGPTConfig) {
                    const saved = DB.saveGPTConfig(cfg);
                    // æ¸…ç©ºå¢å¼ºæœåŠ¡ç¼“å­˜ï¼Œç¡®ä¿åç»­çŠ¶æ€æ£€æŸ¥ä½¿ç”¨æœ€æ–°é…ç½®
                    try { if (typeof wordEnhancementService !== 'undefined') { wordEnhancementService.gptConfig = null; } } catch(_){}
                    const uid = (typeof DB !== 'undefined' && DB.getCurrentUserId) ? (DB.getCurrentUserId() || 'default') : 'default';
                    resultDiv.innerHTML = `<div class="status success">âœ… å·²ä¿å­˜åˆ°ç”¨æˆ· <strong>${uid}</strong> çš„åº”ç”¨é…ç½®</div>`;
                    // ç«‹å³åˆ·æ–°æœåŠ¡çŠ¶æ€æ˜¾ç¤º
                    checkServiceStatus();
                } else {
                    resultDiv.innerHTML = '<div class="status error">âŒ ä¿å­˜å¤±è´¥ï¼šDB.saveGPTConfig ä¸å¯ç”¨</div>';
                }
            } catch (e) {
                console.error('ä¿å­˜GPTé…ç½®å¤±è´¥:', e);
                resultDiv.innerHTML = `<div class="status error">âŒ ä¿å­˜å¤±è´¥ï¼š${e && e.message ? e.message : e}</div>`;
            }
        }

        // åˆå§‹åŒ–é¢„ç½®æ¨¡å‹ä¸‹æ‹‰ï¼šæ¸²æŸ“é€‰é¡¹å¹¶ç»‘å®šé€‰æ‹©å¡«å……é€»è¾‘
        function initPresetModels() {
            const sel = document.getElementById('testModelSelect');
            const help = document.getElementById('testModelHelp');
            if (!sel) return;

            const BUILT_IN_MODELS = (window.BUILT_IN_MODELS_LIST || []);

            sel.innerHTML = '<option value="">-- é€‰æ‹©é¢„ç½®æ¨¡å‹ï¼ˆå¯é€‰ï¼‰ --</option>';
            BUILT_IN_MODELS.forEach(function(line){
                const parts = String(line || '').split(',');
                const model = (parts[1]||'').trim();
                const opt = document.createElement('option');
                opt.value = line;
                const label = (typeof window.renderModelOptionLabel === 'function') ? window.renderModelOptionLabel(line) : (model + ' By APIæ˜“');
                opt.textContent = label;
                sel.appendChild(opt);
            });

            sel.onchange = function(){
                const val = sel.value;
                if (!val) return;
                const parts = val.split(',');
                let api = (parts[0]||'').trim();
                const model = (parts[1]||'').trim();
                const desc = (parts[2]||'').trim();
                const paid = (parts[3]||'').trim();
                let baseUrl = api.replace(/\/?v1\/?chat\/?completions\/?$/i, '');
                baseUrl = baseUrl.replace(/\/$/, '');
                document.getElementById('testBaseUrl').value = baseUrl;
                document.getElementById('testModel').value = model;
                if (help) {
                    if (typeof window.renderModelHelpHtml === 'function') {
                        help.innerHTML = window.renderModelHelpHtml(val);
                    } else {
                        help.innerHTML = 'API: <code>' + api + '</code><br/>' +
                            'æ¨¡å‹: <code>' + model + '</code><br/>' +
                            'è¯´æ˜: ' + desc + '<br/>' +
                            'æ˜¯å¦æ”¶è´¹: ' + paid + '<br/>' +
                            'æ–‡æ¡£ï¼š<a href="https://docs.apiyi.com/api-manual" target="_blank">https://docs.apiyi.com/api-manual</a>';
                    }
                }
            };

            // æ ¹æ®ç°æœ‰é…ç½®å°è¯•åŒ¹é…é€‰ä¸­
            try {
                const cfg = (typeof DB !== 'undefined' && DB.getGPTConfig) ? DB.getGPTConfig() : {};
                const idx = BUILT_IN_MODELS.findIndex(function(line){
                    const parts = line.split(',');
                    return (parts[1]||'').trim() === (cfg.model||'').trim();
                });
                if (idx >= 0) sel.selectedIndex = idx + 1;
            } catch(_){ }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            console.log('è°ƒè¯•é¡µé¢å·²åŠ è½½');
            // åˆå§‹åŒ–æ•°æ®åº“ï¼Œç¡®ä¿è¯»å–åˆ°å½“å‰ç”¨æˆ·ID
            try {
                if (typeof DB !== 'undefined' && DB.init) {
                    DB.init();
                }
            } catch (_) {}
            // é‡ç½®å¢å¼ºæœåŠ¡çš„ç¼“å­˜é…ç½®ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°é…ç½®
            try {
                if (typeof wordEnhancementService !== 'undefined') {
                    wordEnhancementService.gptConfig = null;
                }
            } catch (_) {}
            
            // ä»ä¸»åº”ç”¨è·å–å½“å‰é…ç½®
            if (typeof DB !== 'undefined' && DB.getGPTConfig) {
                const config = DB.getGPTConfig();
                if (config.baseUrl) document.getElementById('testBaseUrl').value = config.baseUrl;
                if (config.model) document.getElementById('testModel').value = config.model;
                if (config.apiKey) document.getElementById('testApiKey').value = config.apiKey;
            }

            // æ˜¾ç¤ºå½“å‰ç”¨æˆ·ä¿¡æ¯
            try {
                const uid = (typeof DB !== 'undefined' && DB.getCurrentUserId) ? (DB.getCurrentUserId() || 'default') : 'default';
                const el = document.getElementById('currentUserInfo');
                if (el) {
                    el.textContent = `å½“å‰ç”¨æˆ·ï¼š${uid} â€”â€” GPT é…ç½®æŒ‰ç”¨æˆ·éš”ç¦»ä¿å­˜`;
                }
            } catch(_){ }

            // åˆå§‹åŒ–é¢„ç½®æ¨¡å‹ä¸‹æ‹‰
            initPresetModels();
            
            // å®æ—¶åˆ·æ–°è¯åº“æ€»æ•°æ˜¾ç¤º
            (function refreshWordCount(){
                try {
                    const span = document.getElementById('wordCountInfo');
                    if (span && typeof DB !== 'undefined') {
                        const list = DB.fileData || [];
                        const total = Array.isArray(list) ? list.length : 0;
                        span.textContent = `ï¼ˆæ€»è¯æ•°ï¼š${total}ï¼‰`;
                    }
                } catch(_){ }
                setTimeout(refreshWordCount, 1500);
            })();

            // è‡ªåŠ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€
            setTimeout(checkServiceStatus, 500);
        });
    </script>
</body>
</html>
